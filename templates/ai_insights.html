{% extends "base.html" %}

{% block title %}AI Insights - {{ current_user.shop_name or 'Retail Manager' }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="bi bi-robot text-primary"></i> AI Business Insights</h2>
            <p class="text-muted">Get intelligent recommendations for your {{ current_user.shop_name or 'business' }}</p>
        </div>
        <div class="col-md-4 text-end">
            <button id="generateInsightsHeaderBtn" class="btn btn-primary" onclick="document.getElementById('generateInsightsBtn').click()">
                <i class="bi bi-magic"></i> Generate Insights
            </button>
        </div>
    </div>

    <!-- AI Insights Card -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-lightbulb"></i> Smart Business Analysis
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Generate Insights Button -->
                    <div class="text-center mb-4">
                        <button id="generateInsightsBtn" class="btn btn-primary btn-lg">
                            <i class="bi bi-magic"></i> Generate AI Insights
                        </button>
                        <p class="text-muted mt-2">Analyze your last 30 days of business data</p>
                    </div>

                    <!-- Loading Spinner -->
                    <div id="loadingSpinner" class="text-center d-none">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">Analyzing your business data...</p>
                    </div>

                    <!-- Error Message -->
                    <div id="errorMessage" class="alert alert-danger d-none" role="alert">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span id="errorText"></span>
                    </div>

                    <!-- Insights Content -->
                    <div id="insightsContent" class="d-none">
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>AI Analysis Period:</strong> Last 30 days of business data
                                </div>
                            </div>
                        </div>

                        <!-- AI Insights Sections -->
                        <div class="row">
                            <!-- Top Selling Products -->
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-trophy"></i> Top Performing Products
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="topPerformersSection">
                                            <div class="text-muted">Analyzing product performance...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Slow Moving Products -->
                            <div class="col-md-6 mb-4">
                                <div class="card h-100 border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-exclamation-triangle"></i> Slow Moving Products
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="slowMoversSection">
                                            <div class="text-muted">Identifying slow-moving items...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Inventory Analysis -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-boxes"></i> Inventory Analysis
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="inventoryAnalysisSection">
                                            <div class="text-muted">Analyzing inventory patterns...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sales Trends -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-graph-up"></i> Sales Trend Analysis
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="salesTrendSection">
                                            <div class="text-muted">Analyzing sales patterns...</div>
                                        </div>
                                        <!-- Sales Chart -->
                                        <div class="mt-4">
                                            <canvas id="salesTrendChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Purchase Recommendations -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-cart-plus"></i> AI Purchase Recommendations
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="purchaseRecommendationsSection">
                                            <div class="text-muted">Generating purchase recommendations...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Predictive Insights -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-crystal-ball"></i> Predictive Insights
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="predictiveInsightsSection">
                                            <div class="text-muted">Analyzing future trends...</div>
                                        </div>
                                        <!-- Forecast Chart -->
                                        <div class="mt-4">
                                            <canvas id="forecastChart" width="400" height="200"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI Market Analysis -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-graph-up-arrow"></i> AI Market Analysis
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="marketAnalysisSection">
                                            <div class="text-muted">Generating AI market insights...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- AI-Powered Interactive Charts -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="card border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-bar-chart-line"></i> AI-Powered Analytics Dashboard
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <div class="card h-100">
                                                    <div class="card-header">
                                                        <h6><i class="bi bi-graph-up"></i> AI Sales Forecast</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <canvas id="aiSalesForecastChart" width="400" height="200"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <div class="card h-100">
                                                    <div class="card-header">
                                                        <h6><i class="bi bi-bar-chart"></i> AI Product Performance</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <canvas id="aiProductPerformanceChart" width="400" height="200"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-4 mb-3">
                                                <div class="card h-100">
                                                    <div class="card-header">
                                                        <h6><i class="bi bi-people"></i> Customer Behavior</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <canvas id="aiCustomerBehaviorChart" width="400" height="200"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="card h-100">
                                                    <div class="card-header">
                                                        <h6><i class="bi bi-arrow-repeat"></i> Inventory Turnover</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <canvas id="aiInventoryTurnoverChart" width="400" height="200"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-4 mb-3">
                                                <div class="card h-100">
                                                    <div class="card-header">
                                                        <h6><i class="bi bi-currency-dollar"></i> Profit Margins</h6>
                                                    </div>
                                                    <div class="card-body">
                                                        <canvas id="aiProfitMarginsChart" width="400" height="200"></canvas>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Actionable Recommendations -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="card border-dark">
                                    <div class="card-header bg-dark text-white">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-lightbulb"></i> Actionable Recommendations
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div id="recommendationsSection">
                                            <div class="text-muted">Generating recommendations...</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Raw AI Response (Collapsible) -->
                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-header">
                                        <button class="btn btn-link text-decoration-none p-0" type="button" data-bs-toggle="collapse" data-bs-target="#rawInsights">
                                            <i class="bi bi-chevron-down"></i> View Full AI Analysis
                                        </button>
                                    </div>
                                    <div class="collapse" id="rawInsights">
                                        <div class="card-body">
                                            <div id="insightsText" class="insights-text">
                                                <!-- Raw AI insights will be populated here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Items -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card border-success">
                                    <div class="card-header bg-success text-white">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-check-circle"></i> Quick Actions
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-3 mb-2">
                                                <a href="{{ url_for('products') }}" class="btn btn-outline-success w-100">
                                                    <i class="bi bi-box-seam"></i> Manage Products
                                                </a>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <a href="{{ url_for('stock_management') }}" class="btn btn-outline-warning w-100">
                                                    <i class="bi bi-box2"></i> Check Stock
                                                </a>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <a href="{{ url_for('analytics') }}" class="btn btn-outline-info w-100">
                                                    <i class="bi bi-graph-up"></i> View Analytics
                                                </a>
                                            </div>
                                            <div class="col-md-3 mb-2">
                                                <button id="refreshInsightsBtn" class="btn btn-outline-primary w-100">
                                                    <i class="bi bi-arrow-clockwise"></i> Refresh Insights
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Cards -->
    <div class="row mt-4">
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-graph-up-arrow display-4 text-success mb-3"></i>
                    <h5 class="card-title">Sales Analysis</h5>
                    <p class="card-text text-muted">AI analyzes your sales patterns and identifies trends to help optimize revenue.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-boxes display-4 text-warning mb-3"></i>
                    <h5 class="card-title">Inventory Optimization</h5>
                    <p class="card-text text-muted">Get recommendations on stock levels and identify fast-moving products.</p>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card h-100">
                <div class="card-body text-center">
                    <i class="bi bi-lightbulb display-4 text-info mb-3"></i>
                    <h5 class="card-title">Business Recommendations</h5>
                    <p class="card-text text-muted">Receive actionable insights to improve profitability and efficiency.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.insights-text {
    font-size: 1.1rem;
    line-height: 1.6;
    white-space: pre-wrap;
}

.insights-text h1, .insights-text h2, .insights-text h3 {
    color: #0d6efd;
    margin-top: 1.5rem;
    margin-bottom: 1rem;
}

.insights-text h1 {
    font-size: 1.5rem;
    border-bottom: 2px solid #0d6efd;
    padding-bottom: 0.5rem;
}

.insights-text h2 {
    font-size: 1.3rem;
}

.insights-text h3 {
    font-size: 1.2rem;
}

.insights-text ul, .insights-text ol {
    margin-left: 1.5rem;
}

.insights-text li {
    margin-bottom: 0.5rem;
}

.insights-text strong {
    color: #198754;
}

.welcome-header {
    text-align: center;
    padding: 2rem 0;
}

.card {
    border: none;
    border-radius: 10px;
}

.card-header {
    border-radius: 10px 10px 0 0 !important;
}

.btn-lg {
    padding: 0.75rem 2rem;
    font-size: 1.1rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const generateBtn = document.getElementById('generateInsightsBtn');
    const refreshBtn = document.getElementById('refreshInsightsBtn');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorMessage = document.getElementById('errorMessage');
    const errorText = document.getElementById('errorText');
    const insightsContent = document.getElementById('insightsContent');
    const insightsText = document.getElementById('insightsText');

    function showLoading() {
        generateBtn.style.display = 'none';
        loadingSpinner.classList.remove('d-none');
        errorMessage.classList.add('d-none');
        insightsContent.classList.add('d-none');
    }

    function hideLoading() {
        generateBtn.style.display = 'inline-block';
        loadingSpinner.classList.add('d-none');
    }

    function showError(message) {
        hideLoading();
        errorText.textContent = message;
        errorMessage.classList.remove('d-none');
        insightsContent.classList.add('d-none');
    }

    function showInsights(insights) {
        hideLoading();
        errorMessage.classList.add('d-none');
        
        // Parse and format insights into sections
        parseInsightsIntoSections(insights);
        
        // Also show raw insights
        const formattedInsights = insights
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n\n/g, '</p><p>')
            .replace(/\n/g, '<br>');
        
        insightsText.innerHTML = '<p>' + formattedInsights + '</p>';
        insightsContent.classList.remove('d-none');
    }

    function parseInsightsIntoSections(insights) {
        console.log('Parsing insights into sections...');
        console.log('Insights length:', insights.length);
        
        // Split insights by section headers
        const sections = insights.split(/##\s*/);
        console.log('Found sections:', sections.length);
        
        sections.forEach((section, index) => {
            const lines = section.trim().split('\n');
            const title = lines[0].trim();
            const content = lines.slice(1).join('\n').trim();
            
            console.log(`Section ${index}: "${title}"`);
            
            if (title.includes('TOP PERFORMING PRODUCTS')) {
                const element = document.getElementById('topPerformersSection');
                if (element) {
                    element.innerHTML = parseProductSection(content, 'success');
                    console.log('Updated top performers section');
                }
            } else if (title.includes('SLOW MOVING PRODUCTS')) {
                const element = document.getElementById('slowMoversSection');
                if (element) {
                    element.innerHTML = parseProductSection(content, 'warning');
                    console.log('Updated slow movers section');
                }
            } else if (title.includes('INVENTORY ANALYSIS')) {
                const element = document.getElementById('inventoryAnalysisSection');
                if (element) {
                    element.innerHTML = parseInventorySection(content);
                    console.log('Updated inventory analysis section');
                }
            } else if (title.includes('SALES TREND ANALYSIS')) {
                const element = document.getElementById('salesTrendSection');
                if (element) {
                    element.innerHTML = parseSalesTrendSection(content);
                    console.log('Updated sales trend section');
                }
            } else if (title.includes('PURCHASE RECOMMENDATIONS')) {
                const element = document.getElementById('purchaseRecommendationsSection');
                if (element) {
                    element.innerHTML = parsePurchaseRecommendationsSection(content);
                    console.log('Updated purchase recommendations section');
                }
            } else if (title.includes('PREDICTIVE INSIGHTS')) {
                const element = document.getElementById('predictiveInsightsSection');
                if (element) {
                    element.innerHTML = parsePredictiveInsightsSection(content);
                    console.log('Updated predictive insights section');
                }
            } else if (title.includes('AI MARKET ANALYSIS')) {
                const element = document.getElementById('marketAnalysisSection');
                if (element) {
                    element.innerHTML = parseMarketAnalysisSection(content);
                    console.log('Updated market analysis section');
                }
            } else if (title.includes('ACTIONABLE RECOMMENDATIONS')) {
                const element = document.getElementById('recommendationsSection');
                if (element) {
                    element.innerHTML = parseRecommendationsSection(content);
                    console.log('Updated recommendations section');
                }
            }
        });
        
        // Parse and create AI-powered charts
        console.log('Creating AI charts...');
        parseAndCreateAICharts(insights);
    }

    function parseProductSection(section, type) {
        const lines = section.split('\n').filter(line => line.trim().startsWith('-'));
        if (lines.length === 0) return '';
        
        const products = lines.map(line => {
            const content = line.replace(/^-\s*/, '').trim();
            const parts = content.split(':');
            const name = parts[0] || 'Unknown Product';
            const details = parts[1] || 'No details available';
            
            // Extract revenue if mentioned
            const revenueMatch = details.match(/₹[\d,]+/);
            const revenue = revenueMatch ? revenueMatch[0] : '₹0';
            
            return {
                name: name,
                sales: revenue,
                trend: type === 'success' ? 'up' : 'down'
            };
        });
        
        return createProductTable(products, type);
    }

    function parseInventorySection(section) {
        const content = section.replace(/INVENTORY ANALYSIS/i, '').trim();
        if (!content) return createInventoryCards();
        
        // Extract percentages if available
        const wellStockedMatch = content.match(/(\d+)%.*well[- ]stock/i);
        const lowStockMatch = content.match(/(\d+)%.*low[- ]stock/i);
        const outStockMatch = content.match(/(\d+)%.*out[- ]of[- ]stock/i);
        
        const wellStocked = wellStockedMatch ? wellStockedMatch[1] : '85';
        const lowStock = lowStockMatch ? lowStockMatch[1] : '12';
        const outStock = outStockMatch ? outStockMatch[1] : '3';
        
        return `
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card border-success">
                        <div class="card-body text-center">
                            <i class="bi bi-check-circle display-6 text-success"></i>
                            <h6 class="mt-2">Well Stocked</h6>
                            <p class="text-muted mb-0">${wellStocked}% of products</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card border-warning">
                        <div class="card-body text-center">
                            <i class="bi bi-exclamation-triangle display-6 text-warning"></i>
                            <h6 class="mt-2">Low Stock</h6>
                            <p class="text-muted mb-0">${lowStock}% of products</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card border-danger">
                        <div class="card-body text-center">
                            <i class="bi bi-x-circle display-6 text-danger"></i>
                            <h6 class="mt-2">Out of Stock</h6>
                            <p class="text-muted mb-0">${outStock}% of products</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <div class="alert alert-info">
                    <strong>Analysis:</strong> ${formatSectionContent(content)}
                </div>
            </div>`;
    }

    function parseSalesTrendSection(section) {
        const content = section.replace(/SALES TREND ANALYSIS/i, '').trim();
        
        // Parse different trend categories
        const trends = {
            growth: extractTrendData(content, 'growth|decline'),
            peaks: extractTrendData(content, 'peak sales|peak days'),
            traffic: extractTrendData(content, 'customer traffic|traffic patterns'),
            revenue: extractTrendData(content, 'revenue trends')
        };
        
        // Extract daily sales data for chart
        const chartDataMatch = content.match(/Day\d+[:\s]*₹?[\d,]+/g);
        if (chartDataMatch) {
            const chartData = chartDataMatch.map(item => {
                const match = item.match(/Day(\d+)[:\s]*₹?([\d,]+)/);
                if (match) {
                    return { day: match[1], amount: parseInt(match[2].replace(/,/g, '')) };
                }
            }).filter(Boolean);
            setTimeout(() => createSalesTrendChart(chartData), 100);
        }
        
        return `
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card border-primary h-100">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="bi bi-graph-up"></i> Growth Analysis</h6>
                        </div>
                        <div class="card-body">
                            <small>${trends.growth || 'Analyzing growth patterns...'}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card border-success h-100">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="bi bi-star"></i> Peak Performance</h6>
                        </div>
                        <div class="card-body">
                            <small>${trends.peaks || 'Identifying peak periods...'}</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card border-info h-100">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="bi bi-people"></i> Customer Traffic</h6>
                        </div>
                        <div class="card-body">
                            <small>${trends.traffic || 'Analyzing traffic patterns...'}</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card border-warning h-100">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="bi bi-currency-dollar"></i> Revenue Trends</h6>
                        </div>
                        <div class="card-body">
                            <small>${trends.revenue || 'Analyzing revenue patterns...'}</small>
                        </div>
                    </div>
                </div>
            </div>`;
    }
    
    function extractTrendData(content, keyword) {
        const lines = content.split(/[•\n]/);
        const relevantLines = lines.filter(line => 
            new RegExp(keyword, 'i').test(line) && line.trim().length > 10
        );
        
        if (relevantLines.length > 0) {
            return relevantLines[0].replace(/^[•\-\s]*/, '').trim();
        }
        
        return null;
    }

    function parseRecommendationsSection(section) {
        const content = section.replace(/ACTIONABLE RECOMMENDATIONS/i, '').trim();
        const lines = content.split('\n').filter(line => line.match(/^\d+\./));
        
        if (lines.length === 0) return createRecommendationsList();
        
        let html = '<div class="list-group list-group-flush">';
        
        lines.forEach((line, index) => {
            const cleanLine = line.replace(/^\d+\.\s*/, '').trim();
            const parts = cleanLine.split(':');
            const title = parts[0] ? parts[0].replace(/\*\*/g, '') : `Recommendation ${index + 1}`;
            const description = parts[1] || 'No description available';
            
            const colors = ['primary', 'success', 'info', 'warning'];
            const color = colors[index % colors.length];
            
            html += `
                <div class="list-group-item d-flex align-items-center">
                    <i class="bi bi-${index + 1}-circle-fill text-${color} me-3"></i>
                    <div>
                        <strong>${title}</strong>
                        <p class="mb-0 text-muted">${description}</p>
                    </div>
                </div>`;
        });
        
        html += '</div>';
        return html;
    }

    function parsePurchaseRecommendationsSection(section) {
        const content = section.replace(/PURCHASE RECOMMENDATIONS/i, '').trim();
        if (!content) return createPurchaseRecommendations();
        
        return `
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card border-success h-100">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="bi bi-arrow-up-circle"></i> High Priority</h6>
                        </div>
                        <div class="card-body">
                            <div id="highPriorityPurchases">
                                ${extractPurchaseItems(content, 'high priority')}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card border-warning h-100">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="bi bi-dash-circle"></i> Medium Priority</h6>
                        </div>
                        <div class="card-body">
                            <div id="mediumPriorityPurchases">
                                ${extractPurchaseItems(content, 'medium priority')}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card border-danger h-100">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0"><i class="bi bi-x-circle"></i> Avoid Purchasing</h6>
                        </div>
                        <div class="card-body">
                            <div id="avoidPurchases">
                                ${extractPurchaseItems(content, 'avoid')}
                            </div>
                        </div>
                    </div>
                </div>
            </div>`;
    }

    function parsePredictiveInsightsSection(section) {
        const content = section.replace(/PREDICTIVE INSIGHTS/i, '').trim();
        if (!content) return createPredictiveInsights();
        
        return `
            <div class="alert alert-primary">
                <strong>AI Predictions:</strong> ${formatSectionContent(content)}
            </div>`;
    }
    
    // This function is defined below with better logic
    
    function formatSectionContent(content) {
        return content
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            .replace(/\n/g, '<br>')
            .replace(/- /g, '• ');
    }

    function extractPurchaseItems(content, type) {
        console.log(`DEBUG: Extracting ${type} items from content:`, content.substring(0, 200));
        
        const lines = content.split('\n');
        let sectionFound = false;
        let items = [];
        
        // Look for the specific section header
        const sectionHeaders = {
            'high priority': ['HIGH PRIORITY PRODUCTS', 'HIGH PRIORITY', 'RESTOCK URGENTLY'],
            'medium priority': ['MEDIUM PRIORITY PRODUCTS', 'MEDIUM PRIORITY'],
            'avoid purchasing': ['LOW PRIORITY/AVOID', 'AVOID PURCHASING', 'LOW PRIORITY']
        };
        
        const headers = sectionHeaders[type.toLowerCase()] || [];
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            
            // Check if we found a section header
            if (headers.some(header => line.toUpperCase().includes(header))) {
                sectionFound = true;
                continue;
            }
            
            // If we're in the right section and find a product line
            if (sectionFound && line.startsWith('-') && line.length > 5) {
                items.push(line.substring(1).trim()); // Remove the dash
            }
            
            // Stop if we hit another section
            if (sectionFound && line.includes('**') && !headers.some(header => line.toUpperCase().includes(header))) {
                break;
            }
        }
        
        console.log(`DEBUG: Found ${items.length} items for ${type}:`, items);
        
        if (items.length === 0) {
            return `<small class="text-muted">No ${type} recommendations found in AI response</small>`;
        }
        
        return items.map(item => 
            `<small>${item}</small>`
        ).join('<br>');
    }

    function createPurchaseRecommendations() {
        return `
            <div class="row">
                <div class="col-md-4 mb-3">
                    <div class="card border-success h-100">
                        <div class="card-header bg-success text-white">
                            <h6 class="mb-0"><i class="bi bi-arrow-up-circle"></i> High Priority</h6>
                        </div>
                        <div class="card-body">
                            <small class="text-muted">
                                • Fast-moving Product A: 50 units<br>
                                • Popular Product B: 30 units<br>
                                • Seasonal Item C: 25 units
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card border-warning h-100">
                        <div class="card-header bg-warning text-dark">
                            <h6 class="mb-0"><i class="bi bi-dash-circle"></i> Medium Priority</h6>
                        </div>
                        <div class="card-body">
                            <small class="text-muted">
                                • Product D: 20 units<br>
                                • Product E: 15 units<br>
                                • Monitor demand trends
                            </small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card border-danger h-100">
                        <div class="card-header bg-danger text-white">
                            <h6 class="mb-0"><i class="bi bi-x-circle"></i> Avoid Purchasing</h6>
                        </div>
                        <div class="card-body">
                            <small class="text-muted">
                                • Product X: Currently overstocked<br>
                                • Product Y: Declining demand<br>
                                • Focus on existing inventory
                            </small>
                        </div>
                    </div>
                </div>
            </div>`;
    }

    function createPredictiveInsights() {
        setTimeout(() => createForecastChart('+8.5'), 100);
        
        return `
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <i class="bi bi-graph-up-arrow display-4 text-success"></i>
                            <h5 class="mt-2">30-Day Forecast</h5>
                            <h3 class="text-success">+8.5%</h3>
                            <p class="text-muted">Expected growth</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <i class="bi bi-cash-stack display-4 text-info"></i>
                            <h5 class="mt-2">Cash Flow</h5>
                            <p class="text-success">Optimized</p>
                            <p class="text-muted">Based on AI predictions</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="alert alert-info">
                <strong>AI Predictions:</strong> Based on historical trends, expect moderate growth in the next 30 days with opportunities in fast-moving categories.
            </div>`;
    }

    function formatSectionContent(content) {
        return content
            .replace(/\*\*(.*?)\*\*/g, '<strong class="text-primary">$1</strong>')
            .replace(/\n-/g, '<br>•')
            .replace(/\n\n/g, '<br><br>')
            .replace(/\n/g, '<br>');
    }

    function createProductTable(products, type) {
        const colorClass = type === 'success' ? 'table-success' : 'table-warning';
        let html = `<div class="table-responsive">
            <table class="table table-sm ${colorClass}">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Sales</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody>`;
        
        products.forEach(product => {
            const trendIcon = product.trend === 'up' ? 'bi-arrow-up text-success' : 
                             product.trend === 'down' ? 'bi-arrow-down text-danger' : 
                             'bi-dash text-muted';
            html += `<tr>
                <td><strong>${product.name}</strong></td>
                <td>${product.sales}</td>
                <td><i class="bi ${trendIcon}"></i></td>
            </tr>`;
        });
        
        html += '</tbody></table></div>';
        return html;
    }

    function createSalesTrendChart(chartData = null) {
        // Create Chart.js chart for sales trends
        if (chartData) {
            const labels = chartData.map(item => `Day ${item.day}`);
            const data = chartData.map(item => item.amount);
            
            setTimeout(() => {
                const ctx = document.getElementById('salesTrendChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Daily Sales (₹)',
                                data: data,
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Sales Trend (Last 7 Days)'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            }, 200);
        } else {
            // Default chart with sample data
            setTimeout(() => {
                const ctx = document.getElementById('salesTrendChart');
                if (ctx) {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'],
                            datasets: [{
                                label: 'Daily Sales (₹)',
                                data: [1200, 1900, 3000, 5000, 2000, 3000, 4500],
                                borderColor: 'rgb(75, 192, 192)',
                                backgroundColor: 'rgba(75, 192, 192, 0.2)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Sales Trend (Last 7 Days)'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                }
            }, 200);
        }
        
        return `
            <div class="row">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <i class="bi bi-graph-up display-4 text-success"></i>
                            <h5 class="mt-2">Sales Growth</h5>
                            <h3 class="text-success">+12.5%</h3>
                            <p class="text-muted">vs last period</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body text-center">
                            <i class="bi bi-people display-4 text-info"></i>
                            <h5 class="mt-2">Customer Traffic</h5>
                            <p class="text-success">Increasing</p>
                            <p class="text-muted">Peak hours: 2-4 PM</p>
                        </div>
                    </div>
                </div>
            </div>`;
    }

    function createForecastChart(forecast = '+8.5') {
        // Create Chart.js chart for forecast
        setTimeout(() => {
            const ctx = document.getElementById('forecastChart');
            if (ctx) {
                const forecastValue = parseFloat(forecast);
                const currentValue = 100;
                const futureValue = currentValue + (currentValue * forecastValue / 100);
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Current Month', 'Predicted Next Month'],
                        datasets: [{
                            label: 'Sales Forecast',
                            data: [currentValue, futureValue],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.2)',
                                forecastValue >= 0 ? 'rgba(75, 192, 192, 0.2)' : 'rgba(255, 99, 132, 0.2)'
                            ],
                            borderColor: [
                                'rgba(54, 162, 235, 1)',
                                forecastValue >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: '30-Day Sales Forecast'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Sales Index'
                                }
                            }
                        }
                    }
                });
            }
        }, 300);
    }

    function createRecommendationsList() {
        return `
            <div class="list-group list-group-flush">
                <div class="list-group-item d-flex align-items-center">
                    <i class="bi bi-1-circle-fill text-primary me-3"></i>
                    <div>
                        <strong>Optimize Inventory</strong>
                        <p class="mb-0 text-muted">Restock fast-moving products and reduce slow-moving inventory</p>
                    </div>
                </div>
                <div class="list-group-item d-flex align-items-center">
                    <i class="bi bi-2-circle-fill text-success me-3"></i>
                    <div>
                        <strong>Focus Marketing</strong>
                        <p class="mb-0 text-muted">Promote top-performing products during peak hours</p>
                    </div>
                </div>
                <div class="list-group-item d-flex align-items-center">
                    <i class="bi bi-3-circle-fill text-info me-3"></i>
                    <div>
                        <strong>Price Strategy</strong>
                        <p class="mb-0 text-muted">Consider bundling slow-moving items with popular products</p>
                    </div>
                </div>
                <div class="list-group-item d-flex align-items-center">
                    <i class="bi bi-4-circle-fill text-warning me-3"></i>
                    <div>
                        <strong>Monitor Trends</strong>
                        <p class="mb-0 text-muted">Track daily sales patterns to optimize staffing and promotions</p>
                    </div>
                </div>
            </div>`;
    }

    function generateInsights() {
        showLoading();
        
        fetch('/get_ai_insights')
            .then(response => {
                console.log('Response status:', response.status);
                return response.json();
            })
            .then(data => {
                console.log('Response data:', data);
                if (data.error) {
                    console.error('API Error:', data.error);
                    showError(data.error);
                } else if (data.insights) {
                    console.log('Insights received, length:', data.insights.length);
                    showInsights(data.insights);
                } else {
                    console.error('No insights in response:', data);
                    showError('No insights received from AI service.');
                }
            })
            .catch(error => {
                console.error('Fetch Error:', error);
                showError('Failed to generate insights. Please try again.');
            });
    }

    generateBtn.addEventListener('click', generateInsights);
    
    if (refreshBtn) {
        refreshBtn.addEventListener('click', generateInsights);
    }

    function parseMarketAnalysisSection(content) {
        return `
            <div class="alert alert-info">
                <strong>AI Market Intelligence:</strong> ${formatSectionContent(content)}
            </div>`;
    }

    function parseAndCreateAICharts(insights) {
        // Extract chart data from AI response
        const chartDataRegex = /CHART_DATA_(\w+):\s*([^\n]+)/g;
        let match;
        
        while ((match = chartDataRegex.exec(insights)) !== null) {
            const chartType = match[1];
            const chartData = match[2];
            
            switch(chartType) {
                case 'FORECAST':
                    createAISalesForecastChart(chartData);
                    break;
                case 'PRODUCTS':
                    createAIProductPerformanceChart(chartData);
                    break;
                case 'BEHAVIOR':
                    createAICustomerBehaviorChart(chartData);
                    break;
                case 'TURNOVER':
                    createAIInventoryTurnoverChart(chartData);
                    break;
                case 'MARGINS':
                    createAIProfitMarginsChart(chartData);
                    break;
            }
        }
    }

    function createAISalesForecastChart(data) {
        const items = data.split(',');
        const labels = items.map(item => item.split(':')[0]);
        const values = items.map(item => parseFloat(item.split(':')[1]));
        
        setTimeout(() => {
            const ctx = document.getElementById('aiSalesForecastChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'AI Predicted Sales (₹)',
                            data: values,
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.2)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'AI-Powered Sales Forecast'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Sales Amount (₹)'
                                }
                            }
                        }
                    }
                });
            }
        }, 300);
    }

    function createAIProductPerformanceChart(data) {
        const items = data.split(',');
        const labels = items.map(item => item.split(':')[0]);
        const values = items.map(item => parseFloat(item.split(':')[1]));
        
        setTimeout(() => {
            const ctx = document.getElementById('aiProductPerformanceChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'AI Performance Score',
                            data: values,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.2)',
                                'rgba(54, 162, 235, 0.2)',
                                'rgba(255, 205, 86, 0.2)',
                                'rgba(75, 192, 192, 0.2)',
                                'rgba(153, 102, 255, 0.2)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 205, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'AI Product Performance Analysis'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Performance Score'
                                }
                            }
                        }
                    }
                });
            }
        }, 300);
    }

    function createAICustomerBehaviorChart(data) {
        const items = data.split(',');
        const labels = items.map(item => item.split(':')[0]);
        const values = items.map(item => parseFloat(item.split(':')[1]));
        
        setTimeout(() => {
            const ctx = document.getElementById('aiCustomerBehaviorChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Customer Activity',
                            data: values,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.2)',
                            tension: 0.3
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'AI Customer Behavior Pattern'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Activity Level'
                                }
                            }
                        }
                    }
                });
            }
        }, 300);
    }

    function createAIInventoryTurnoverChart(data) {
        const items = data.split(',');
        const labels = items.map(item => item.split(':')[0]);
        const values = items.map(item => parseFloat(item.split(':')[1]));
        
        setTimeout(() => {
            const ctx = document.getElementById('aiInventoryTurnoverChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Turnover Rate',
                            data: values,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 205, 86, 0.8)',
                                'rgba(75, 192, 192, 0.8)',
                                'rgba(153, 102, 255, 0.8)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'AI Inventory Turnover Analysis'
                            }
                        }
                    }
                });
            }
        }, 300);
    }

    function createAIProfitMarginsChart(data) {
        const items = data.split(',');
        const labels = items.map(item => item.split(':')[0]);
        const values = items.map(item => parseFloat(item.split(':')[1]));
        
        setTimeout(() => {
            const ctx = document.getElementById('aiProfitMarginsChart');
            if (ctx) {
                new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Profit Margin %',
                            data: values,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.2)',
                            pointBackgroundColor: 'rgb(54, 162, 235)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(54, 162, 235)'
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'AI Profit Margin Analysis'
                            }
                        },
                        scales: {
                            r: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Profit Margin %'
                                }
                            }
                        }
                    }
                });
            }
        }, 300);
    }
});
</script>
{% endblock %}
